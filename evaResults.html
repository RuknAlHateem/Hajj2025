<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نتائج التقييم - ركن الحطيم</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2d9958;
    }
    .filters {
      text-align: center;
      margin-bottom: 20px;
    }
    .filter-btn {
      border: none;
      margin: 5px;
      padding: 10px 20px;
      background: #e0e0e0;
      border-radius: 20px;
      cursor: pointer;
    }
    .filter-btn.active {
      background: #2d9958;
      color: white;
    }
    .charts-container, .results-container {
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    canvas {
      background: white;
      border-radius: 8px;
      padding: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #2d9958;
      color: white;
    }
  </style>
</head>
<body>

<h1>نتائج استبيان الحجاج</h1>

<div class="filters">
  <div>
    <strong>الحملة:</strong>
    <button class="filter-btn" data-group="campaign" data-value="khalaf">الخلف</button>
    <button class="filter-btn" data-group="campaign" data-value="rayah">الراية الخضراء</button>
    <button class="filter-btn" data-group="campaign" data-value="hydaya">الهداية</button>
  </div>
  <div>
    <strong>الجنس:</strong>
    <button class="filter-btn" data-group="gender" data-value="ذكر">ذكر</button>
    <button class="filter-btn" data-group="gender" data-value="أنثى">أنثى</button>
  </div>
</div>

<div class="charts-container">
  <canvas id="summaryChart" width="400" height="400"></canvas>
</div>

<div class="results-container" id="results"></div>

<script>
  // ربط Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBfL7s5bJKGqXfMQg39JdrWvNO5WcA7GM4",
    authDomain: "hajj2025-56177.firebaseapp.com",
    projectId: "hajj2025-56177",
    storageBucket: "hajj2025-56177.appspot.com",
    messagingSenderId: "730298972866",
    appId: "1:730298972866:web:205b9aa60f7be9fdde51dc"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const selectedFilters = {
    campaign: new Set(),
    gender: new Set()
  };

  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const group = btn.dataset.group;
      const value = btn.dataset.value;
      btn.classList.toggle('active');
      if (selectedFilters[group].has(value)) {
        selectedFilters[group].delete(value);
      } else {
        selectedFilters[group].add(value);
      }
      fetchData();
    });
  });

  async function fetchData() {
    const snapshot = await db.collection('evaluations').get();
    const data = [];

    snapshot.forEach(doc => {
      const entry = doc.data();
      const campaignMatch = selectedFilters.campaign.size === 0 || [...selectedFilters.campaign].some(c => doc.id.startsWith(c));
      const genderMatch = selectedFilters.gender.size === 0 || selectedFilters.gender.has(entry.gender);

      if (campaignMatch && genderMatch) {
        data.push(entry);
      }
    });

    renderChart(data);
    renderResults(data);
  }

  function renderChart(data) {
    const labels = ['الخدمات', 'النقل', 'منى', 'عرفة'];
    const sections = ['logistics', 'transport', 'mina', 'arafa'];
    const averages = sections.map(section => {
      const values = data.map(d => {
        const keys = Object.keys(d).filter(k => k.startsWith(section + '_'));
        const scores = keys.map(k => parseInt(d[k]));
        return scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
      });
      return values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
    });

    const ctx = document.getElementById('summaryChart').getContext('2d');
    if (window.summaryChart) window.summaryChart.destroy();
    window.summaryChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'متوسط التقييم',
          data: averages,
          backgroundColor: ['#2d9958', '#44bde7', '#fab334', '#e8593a']
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 5
          }
        }
      }
    });
  }

  function renderResults(data) {
    const container = document.getElementById('results');
    container.innerHTML = '';

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    const headers = ['الاسم', 'رقم الجوال', 'الجنس', 'الحملة', 'معدل الرضا'];
    thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

    data.forEach(d => {
      const avg = Object.keys(d)
        .filter(k => k.includes('_') && !isNaN(d[k]))
        .map(k => parseFloat(d[k]))
        .reduce((a, b) => a + b, 0) / 20;

      const row = `
        <tr>
          <td>${d.name || '-'}</td>
          <td>${d.phone || '-'}</td>
          <td>${d.gender || '-'}</td>
          <td>${d.campaign || '-'}</td>
          <td>${avg.toFixed(2)}</td>
        </tr>`;
      tbody.innerHTML += row;
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    container.appendChild(table);
  }

  fetchData();
</script>

</body>
</html>