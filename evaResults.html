<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تحليل إجابات الاستبيان - ركن الحطيم</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f5f5f5; padding: 20px; max-width: 900px; margin: auto; }
    h2,h3 { text-align: center; color: #444; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
    .filters label { background: #fff; padding: 8px 14px; border-radius: 8px; box-shadow: 0 1px 3px #ccc; }
    .card { background: #fff; margin-bottom: 20px; border-radius: 10px; padding: 15px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .card h4 { margin: 10px 0; }
    .notes { display: flex; gap: 10px; flex-wrap: wrap; }
    .note-col { flex: 1; min-width: 250px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px #ddd; }
    .note-col h4 { margin-top: 0; }
    ul { padding-inline-start: 20px; }
  </style>
</head>
<body>

<h2>تحليل إجابات الاستبيان</h2>

<div class="filters">
  <fieldset><legend>الحملة:</legend>
    <label><input type="checkbox" value="حملة الخلف" checked> الخلف</label>
    <label><input type="checkbox" value="حملة الراية الخضراء" checked> الراية الخضراء</label>
    <label><input type="checkbox" value="حملة الهداية" checked> الهداية</label>
  </fieldset>
  <fieldset><legend>الجنس:</legend>
    <label><input type="checkbox" value="ذكر" checked> ذكر</label>
    <label><input type="checkbox" value="أنثى" checked> أنثى</label>
  </fieldset>
</div>

<div id="analytics"></div>

<div class="card notes">
  <div class="note-col"><h4>إيجابي</h4><ul id="notes-positive"></ul></div>
  <div class="note-col"><h4>سلبي</h4><ul id="notes-negative"></ul></div>
  <div class="note-col"><h4>مقترح</h4><ul id="notes-suggestions"></ul></div>
</div>

<script>
  // إعداد Firebase:
  firebase.initializeApp({
    apiKey: "...", authDomain: "...", projectId: "..."
  });
  const db = firebase.firestore();

  const filterEls = { campaigns: [], genders: [] };
  document.querySelectorAll('.filters input').forEach(chk => chk.addEventListener('change', () => load()));

  async function load() {
    const checked = field => Array.from(document.querySelectorAll(`.${field}-filter:checked`)).map(i => i.value);
    filterEls.campaigns = checked('campaign');
    filterEls.genders = checked('gender');

    const data = (await db.collection('evaluation').get()).docs
      .map(d => d.data())
      .filter(r => filterEls.campaigns.includes(r.campaign) && filterEls.genders.includes(r.gender));

    const totalCount = data.length || 1;

    const stats = (key) => {
      const cnt = data.filter(r => r[key] === 'ضعيف').length;
      return { cnt, pct: ((cnt/totalCount)*100).toFixed(1) };
    };

    // تحليل ١٠ أسئلة مختارة كمثال:
    const analyses = [
      { title: 'ضعيف في نظافة السكن', key: 'housing_q1' },
      { title: 'ضعيف في توافر الراحة في السكن', key: 'housing_q2' },
      { title: 'ضعيف في جودة الطعام', key: 'food_q6' },
      { title: 'ضعيف في مواعيد تقديم الوجبات', key: 'food_q7' },
      { title: 'ضعيف في راحة النقل', key: 'transport_q10' },
      { title: 'ضعيف في أمان السائقين', key: 'transport_q11' },
      { title: 'ضعيف في سرعة الدعم الفني', key: 'logistics_q14' },
      { title: 'ضعيف في وضوح التعليمات', key: 'logistics_q15' },
      { title: 'ضعيف في نظافة مخيم منى', key: 'mina_q19' },
      { title: 'ضعيف في سهولة التفويج من عرفة', key: 'arafat_q29' }
    ];

    document.getElementById('analytics').innerHTML = analyses.map(a => {
      const s = stats(a.key);
      return `<div class="card"><h4>${a.title}</h4><p>عدد: ${s.cnt} (${s.pct}%) من ${totalCount}</p></div>`;
    }).join('');

    // الملاحظات:
    const pos = [], neg = [], sug = [];
    data.forEach(r => {
      r.notes.positive && pos.push(r.notes.positive);
      r.notes.negative && neg.push(r.notes.negative);
      r.notes.suggestions && sug.push(r.notes.suggestions);
    });

    const fillList = (id, arr) => {
      document.getElementById(id).innerHTML = arr.map(t => `<li>${t}</li>`).join('');
    };
    fillList('notes-positive', pos);
    fillList('notes-negative', neg);
    fillList('notes-suggestions', sug);
  }

  load();
</script>

</body>
</html>