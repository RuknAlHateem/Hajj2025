<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>اختبار عرض النتائج</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      background: #f9f9f9;
      padding: 20px;
    }
    h1 { text-align: center; color: #2d9958; }
    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .warning {
      background: #ffe5e5;
      color: #c00;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }
  </style>
</head>
<body>

<h1>اختبار عرض التقييم</h1>
<div class="card" id="message">جاري التحميل...</div>
<div class="card"><canvas id="summaryChart"></canvas></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBfL7s5bJKGqXfMQg39JdrWvNO5WcA7GM4",
    authDomain: "hajj2025-56177.firebaseapp.com",
    projectId: "hajj2025-56177",
    storageBucket: "hajj2025-56177.appspot.com",
    messagingSenderId: "730298972866",
    appId: "1:730298972866:web:205b9aa60f7be9fdde51dc"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  async function fetchData() {
    const msg = document.getElementById('message');
    const snapshot = await db.collection('evaluation').get();
    if (snapshot.empty) {
      msg.innerHTML = '<div class="warning">لا توجد بيانات تقييم حالياً.</div>';
      return;
    }

    const data = [];
    snapshot.forEach(doc => data.push(doc.data()));

    msg.innerHTML = `<strong>تم العثور على ${data.length} تقييم</strong>`;

    renderChart(data);
  }

  function renderChart(data) {
    const sections = ['food', 'arafat', 'mina', 'transport', 'logistics'];
    const labels = ['التغذية', 'عرفة', 'منى', 'النقل', 'الخدمات'];

    const averages = sections.map(section => {
      const sectionAverages = data.map(entry => {
        if (entry[section]) {
          const values = Object.values(entry[section])
            .map(v => v.includes('ممتاز') ? 5 :
                      v.includes('جيد') ? 4 :
                      v.includes('متوسط') ? 3 :
                      v.includes('ضعيف') ? 2 :
                      v.includes('سيئ') ? 1 : 0);
          return values.length ? values.reduce((a,b) => a+b, 0) / values.length : 0;
        } else return 0;
      });
      return sectionAverages.length ? sectionAverages.reduce((a,b) => a+b,0) / sectionAverages.length : 0;
    });

    const ctx = document.getElementById('summaryChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'متوسط التقييم',
          data: averages,
          backgroundColor: ['#2d9958', '#44bde7', '#fab334', '#e8593a', '#b085e9']
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 5 }
        }
      }
    });
  }

  fetchData();
</script>

</body>
</html>