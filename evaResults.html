<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تحليل إجابات الاستبيان</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f9f9f9; padding: 20px; max-width: 600px; margin: auto; }
    h2 { text-align: center; color: #333; }
    .filters { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 10px 0 20px; }
    .filters label { background: white; padding: 8px 14px; border-radius: 8px; box-shadow: 0 1px 3px #ccc; cursor: pointer; }
    .filters input { margin-left: 5px; }
    .card { background: white; padding: 15px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .card h3 { margin-top: 0; font-size: 16px; }
    ul { padding: 0 20px; list-style: disc; }
  </style>
</head>
<body>

<h2>تحليل إجابات الاستبيان</h2>

<div class="filters" id="campaigns">
  <label><input type="checkbox" value="حملة الخلف" checked> حملة الخلف</label>
  <label><input type="checkbox" value="حملة الراية الخضراء" checked> الراية الخضراء</label>
  <label><input type="checkbox" value="حملة الهداية" checked> الهداية</label>
</div>

<div class="filters" id="genders">
  <label><input type="checkbox" value="ذكر" checked> ذكر</label>
  <label><input type="checkbox" value="أنثى" checked> أنثى</label>
</div>

<div class="card" id="logistics-weak"></div>
<div class="card">
  <h3>الملاحظات المفتوحة</h3>
  <ul id="notes-list"></ul>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCjLt3g-2GPsMlxXPnzySXpCHl3-FyA80I",
    authDomain: "hajj2025-56177.firebaseapp.com",
    projectId: "hajj2025-56177",
    storageBucket: "hajj2025-56177.appspot.com",
    messagingSenderId: "199404422758",
    appId: "1:199404422758:web:35a17e6155f660e0128fa7"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const logisticsWeakDiv = document.getElementById('logistics-weak');
  const notesList = document.getElementById('notes-list');

  async function fetchAndRender() {
    const selectedCampaigns = [...document.querySelectorAll('#campaigns input:checked')].map(el => el.value);
    const selectedGenders = [...document.querySelectorAll('#genders input:checked')].map(el => el.value);

    const snapshot = await db.collection("evaluation").get();
    let weakCount = 0;
    let notes = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      if (!selectedCampaigns.includes(data.campaign)) return;
      if (data.gender && !selectedGenders.includes(data.gender)) return;

      // سؤال اللوجستية رقم 13
      if (data.logistics && data.logistics.q13 === "ضعيف") weakCount++;

      // ملاحظات
      notes.push({
        positive: data.notes?.positive || "",
        negative: data.notes?.negative || "",
        suggestions: data.notes?.suggestions || ""
      });
    });

    logisticsWeakDiv.innerHTML = `<h3>ضعيف في سؤال الخدمات اللوجستية ١</h3><p>${weakCount} إجابة</p>`;

    notesList.innerHTML = '';
    notes.forEach(n => {
      if (n.positive) notesList.innerHTML += `<li>إيجابي: ${n.positive}</li>`;
      if (n.negative) notesList.innerHTML += `<li>سلبي: ${n.negative}</li>`;
      if (n.suggestions) notesList.innerHTML += `<li>اقتراح: ${n.suggestions}</li>`;
    });
  }

  document.querySelectorAll('input[type=checkbox]').forEach(cb => cb.addEventListener('change', fetchAndRender));
  fetchAndRender();
</script>

</body>
</html>